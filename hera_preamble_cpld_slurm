#!/bin/sh
#SBATCH -q debug
##SBATCH -q batch
#SBATCH -t 00:30:00
##SBATCH -t 01:00:00
#SBATCH -A da-cpu
##SBATCH -A isp-1         
##SBATCH -A gsienkf
#SBATCH -N 30   
#SBATCH -J ufs_era5_replay
#SBATCH -e ufs_era5_replay.err
#SBATCH -o ufs_era5_replay.out
export NODES=$SLURM_NNODES
export corespernode=$SLURM_CPUS_ON_NODE
export machine='hera'

# for control forecast
if [ $NODES -eq 20 ]; then # 0.25 degree setup
  export gsi_control_thread=4
  export control_threads=1
  export control_proc=800  
  export write_groups=1 # write groups for control forecast.
  export write_tasks=80
  export layout="10,10" # layout_x,layout_y (total # mpi tasks = $layout_x*$layout_y*6=($fg_proc/$fg_threads) - $write_tasks*$write_groups)
  export nprocs_cpl=600
  export nprocs_atm=680
  export nprocs_ice=40
  export nprocs_ocn=80
elif [ $NODES -eq 23 ]; then # 0.25 degree setup
  export gsi_control_thread=4
  export control_threads=1
  export control_proc=920  
  export write_groups=1 # write groups for control forecast.
  export write_tasks=80
  export layout="10,10" # layout_x,layout_y (total # mpi tasks = $layout_x*$layout_y*6=($fg_proc/$fg_threads) - $write_tasks*$write_groups)
  export nprocs_cpl=600
  export nprocs_atm=680
  export nprocs_ice=80
  export nprocs_ocn=160
elif [ $NODES -eq 30 ]; then # 0.25 degree setup
  export gsi_control_thread=2
  export control_threads=1
  export control_proc=1200
  export write_groups=1 # write groups for control forecast.
  export write_tasks=96
  export layout="12,12" # layout_x,layout_y (total # mpi tasks = $layout_x*$layout_y*6=($fg_proc/$fg_threads) - $write_tasks*$write_groups)
  export nprocs_cpl=864
  export nprocs_atm=960
  export nprocs_ice=80
  export nprocs_ocn=160 
elif [ $NODES -eq 69 ]; then # p8 layout
  export gsi_control_threads=4
  export control_threads=1
  export control_proc=2760
  export layout="24,16" 
  export write_groups=1
  export write_tasks=96  
  export nprocs_cpl=2304
  export nprocs_atm=2400
  export nprocs_ice=120
  export nprocs_ocn=240
elif [ $NODES -eq 94 ]; then # 0.25 degree setup
  export gsi_control_threads=4
  export control_threads=2
  export control_proc=3760
  export layout="16,16" 
  export write_groups=1
  export write_tasks=104
  export nprocs_cpl=1536
  export nprocs_atm=1640
  export nprocs_ice=80
  export nprocs_ocn=160
elif [ $NODES -eq 138 ]; then # p8 layout
  export gsi_control_threads=4
  export control_threads=2
  export control_proc=5520
  export layout="24,16" 
  export write_groups=1
  export write_tasks=96  
  export nprocs_cpl=2304
  export nprocs_atm=2400
  export nprocs_ice=120
  export nprocs_ocn=240
else
  echo "processor layout for $NODES nodes not set"
  exit 1
fi

export gsi_control_threads=4
